<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{admin/layouts/ad_layout}">

	<th:block layout:fragment="script1">
		
	<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    
   	
	<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
			
		
	</th:block>

	<th:block layout:fragment="style1">
		<style>
		/* 카드 스타일 */
		.card-primary {
			border: none !important;
			border-radius: 16px !important;
			box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04) !important;
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
			background: linear-gradient(135deg, #fdfbfb 0%, #f6f9fc 100%) !important;
			overflow: hidden !important;
			position: relative !important;
			animation: fadeInUp 0.5s ease !important;
		}
		
		.card-primary::before {
			content: '' !important;
			position: absolute !important;
			top: 0 !important;
			left: 0 !important;
			right: 0 !important;
			height: 4px !important;
			background: linear-gradient(90deg, #667eea 0%, #764ba2 100%) !important;
		}
		
		.card-header {
			background: transparent !important;
			border-bottom: 2px solid rgba(102, 126, 234, 0.15) !important;
			padding: 24px 20px !important;
		}
		
		.card-title {
			font-size: 20px !important;
			font-weight: 600 !important;
			color: #2d3748 !important;
			margin: 0 !important;
		}
		
		.card-body {
			padding: 24px !important;
			background: transparent !important;
		}
		
		/* 버튼 스타일 */
		.btn {
			border-radius: 8px !important;
			padding: 8px 16px !important;
			font-weight: 500 !important;
			transition: all 0.3s ease !important;
			border: none !important;
		}
		
		.btn-outline-success {
			border: 2px solid #43e97b !important;
			color: #43e97b !important;
			background: transparent !important;
		}
		
		.btn-outline-success:hover {
			background: #43e97b !important;
			color: #ffffff !important;
			transform: translateY(-2px) !important;
		}
		
		.btn-success {
			background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%) !important;
			color: #ffffff !important;
			box-shadow: 0 4px 12px rgba(67, 233, 123, 0.3) !important;
			border: none !important;
		}
		
		.btn-success:hover {
			transform: translateY(-2px) !important;
			box-shadow: 0 6px 16px rgba(67, 233, 123, 0.4) !important;
		}
		
		.btn-outline-primary {
			border: 2px solid #667eea !important;
			color: #667eea !important;
			background: transparent !important;
		}
		
		.btn-outline-primary:hover {
			background: #667eea !important;
			color: #ffffff !important;
			transform: translateY(-2px) !important;
		}
		
		/* 입력 필드 스타일 */
		input[type="month"],
		input[type="date"],
		input[type="text"] {
			border: 1px solid rgba(102, 126, 234, 0.2) !important;
			border-radius: 8px !important;
			padding: 10px 14px !important;
			font-size: 14px !important;
			transition: all 0.3s ease !important;
			background: #ffffff !important;
		}
		
		input[type="month"]:focus,
		input[type="date"]:focus,
		input[type="text"]:focus {
			border-color: #667eea !important;
			box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
			outline: none !important;
		}
		
		/* 차트 컨테이너 스타일 */
		.row canvas {
			background: #ffffff !important;
			border-radius: 12px !important;
			padding: 20px !important;
			box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04) !important;
			margin-top: 20px !important;
		}
		
		/* 간격 조정 */
		.row {
			margin-bottom: 16px !important;
		}
		
		.mt-3 {
			margin-top: 20px !important;
		}
		
		.mt-5 {
			margin-top: 32px !important;
		}
		
		/* 카드 푸터 스타일 */
		.card-footer {
			background: transparent !important;
			border-top: 1px solid rgba(0, 0, 0, 0.05) !important;
			padding: 20px !important;
		}
		
		/* jQuery UI Datepicker 커스텀 스타일 */
		.ui-datepicker {
			border: none !important;
			border-radius: 12px !important;
			box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12) !important;
			padding: 16px !important;
			background: #ffffff !important;
		}
		
		.ui-datepicker-header {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
			color: #ffffff !important;
			border: none !important;
			border-radius: 8px !important;
			padding: 12px !important;
			margin-bottom: 12px !important;
		}
		
		.ui-datepicker-title {
			color: #ffffff !important;
			font-weight: 600 !important;
		}
		
		.ui-datepicker-prev,
		.ui-datepicker-next {
			cursor: pointer !important;
		}
		
		.ui-datepicker-prev span,
		.ui-datepicker-next span {
			color: #ffffff !important;
		}
		
		.ui-state-default {
			border: 1px solid rgba(102, 126, 234, 0.2) !important;
			background: #ffffff !important;
			color: #4a5568 !important;
			text-align: center !important;
			border-radius: 6px !important;
			transition: all 0.2s ease !important;
		}
		
		.ui-state-default:hover {
			background: #667eea !important;
			color: #ffffff !important;
			border-color: #667eea !important;
		}
		
		.ui-state-active {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
			color: #ffffff !important;
			border-color: #667eea !important;
		}
		
		.ui-datepicker-buttonpane {
			margin-top: 12px !important;
			padding-top: 12px !important;
			border-top: 1px solid rgba(0, 0, 0, 0.05) !important;
		}
		
		.ui-datepicker-buttonpane button {
			border: 2px solid #667eea !important;
			background: transparent !important;
			color: #667eea !important;
			border-radius: 6px !important;
			padding: 6px 12px !important;
			font-weight: 500 !important;
			transition: all 0.3s ease !important;
		}
		
		.ui-datepicker-buttonpane button:hover {
			background: #667eea !important;
			color: #ffffff !important;
		}
		
		/* 옵션 영역 스타일 */
		.options {
			display: flex !important;
			align-items: center !important;
			gap: 12px !important;
		}
		
		/* 애니메이션 */
		@keyframes fadeInUp {
			from {
				opacity: 0;
				transform: translateY(20px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}
		</style>

	</th:block>

	<th:block layout:fragment="content">
	      
	  <div class="container mt-5">
		<div class="row">
			<div class="col">
				<div class="card card-primary">
					<div class="card-header">
					  <h3 class="card-title">매출통계 대시보드</h3>
					</div>
					<!-- /.card-header -->
					<!-- list start -->
					<div class="card-body">
						 <div class="row">
							<div class="col">
								<button type="button" value="daily" name="statType" class="btn btn-outline-success">일자별</button>
								<button type="button" value="hourly" name="statType" class="btn btn-outline-success">시간별</button>
								<button type="button" value="weekly" name="statType" class="btn btn-outline-success">요일별</button>
								<button type="button" value="monthly" name="statType" class="btn btn-outline-success">월별</button>
							</div>
						 </div>
						 <div class="row mt-3">
							<div id="dailyOptions" class="options col" style="display: block;">
								<input type="month" id="dateInput">
							</div>
							
							<div id="hourlyOptions" class="options col" style="display: none;">
								<input type="date" id="hourlyStartDate"> ~ <input type="date" id="hourlyEndDate">
							</div>

							<div id="weeklyOptions" class="options col" style="display: none;">
								<input type="date" id="weeklyStartDate"> ~ <input type="date" id="weeklyEndDate">
							</div>

							<div id="monthlyOptions" class="options col" style="display: none;">
								<input type="text" id="yearpicker" placeholder="년도 선택하세요.">
							</div>
							<div class="col-2">
								<button type="button" class="btn btn-outline-primary" id="search">검색</button>
						</div>

						 </div>
						 <div class="row">
							<div class="col">
								<canvas id="statsChart" width="400" height="200"></canvas>
							</div>							
						 </div>						 
					</div>

					<div class="card-footer clearfix">
						
					</div>
				 </div>
			</div>
		</div>
	  </div>
	
		
	</th:block>

	<th:block layout:fragment="script2">
		<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>	
		<script>

			$(document).ready(function() {
				
				// 월별 버튼에서 사용할 달력 환경설정				
				$("#yearpicker").datepicker({
					changeYear: true,
					showButtonPanel: true,
					dateFormat: 'yy',
					onClose: function(dateText, inst) { 
						var year = $("#ui-datepicker-div .ui-datepicker-year :selected").val();
						$(this).datepicker('setDate', new Date(year, 1));
					}
            	});

				$("#yearpicker").focus(function () {
					$(".ui-datepicker-month").hide();
					$(".ui-datepicker-calendar").hide();
				});
				
				
				// <canvas>태그를 2d 작업용으로 객체를 참조.
				const ctx = document.getElementById('statsChart').getContext('2d');

            	let chart;

				// 초기 통계 유형
				let type = 'daily';

				// 옵션 영역 표시
				$(`#${type}Options`).show();

				// ----- 버튼 선택 상태 초기화 -----
				// 모든 버튼을 비활성화 상태로 초기화
				$("button[name='statType']").removeClass('btn-success').addClass('btn-outline-success');
				// daily 버튼만 활성화
				$("button[name='statType'][value='daily']").removeClass('btn-outline-success').addClass('btn-success');

				// 일자별, 시간별, 요일별, 월별 버튼을 클릭 이벤트 설정.
				$("button[name='statType']").on("click", function() {
					console.log("버튼", $(this).val());

					type = $(this).val();  // 4개버튼중 선택한 버튼의 값.
					$('.options').hide();  // 4개버튼에서 표시되는 달력을 화면에서 숨김.

					$(`#${type}Options`).show(); // 선택한 버튼에 필요한 달력 보이기.

					// 선택된 버튼에 활성화 스타일 적용
					$("button[name='statType']").removeClass('btn-success').addClass('btn-outline-success'); // 기존 모두 초기화
					$(this).removeClass('btn-outline-success').addClass('btn-success'); // 클릭한 버튼 활성화
				});
				

				// 검색버튼 이벤트 설정.
				$("#search").on("click", function() {										

					let url = `/admin/statist/${type}`;
					let labelName = "";

					console.log("검색", url);
                	
					let params = {};

					if (type == 'daily') { // 일자별 버튼 선택시
						params = {
							date: $('#dateInput').val()
							};
						labelName = $('#dateInput').val();
					} else if (type == 'hourly') {	// 시간별 버튼 선택시
						const date = new Date($('#hourlyEndDate').val());
						date.setDate(date.getDate() + 1);
						
						const year = date.getFullYear();
						const month = String(date.getMonth() + 1).padStart(2, '0');
						const day = String(date.getDate()).padStart(2, '0');

						labelName = $('#hourlyStartDate').val() + " - " + `${year}-${month}-${day - 1}`;

						params = {
							start_date: $('#hourlyStartDate').val(),
							end_date: `${year}-${month}-${day}`
						};
					} else if (type == 'weekly') {	// 요일별 버튼 선택시
						const date = new Date($('#weeklyEndDate').val());
						date.setDate(date.getDate() + 1);
						
						const year = date.getFullYear();
						const month = String(date.getMonth() + 1).padStart(2, '0');
						const day = String(date.getDate()).padStart(2, '0');

						labelName = $('#weeklyStartDate').val() + " - " + `${year}-${month}-${day - 1}`;

						params = {
							start_date: $('#weeklyStartDate').val(),
							end_date: `${year}-${month}-${day}`
						};
					} else if (type == 'monthly') {	// 월별 버튼 선택시
						params = { year: $('#yearpicker').val() };
						labelName = $('#yearpicker').val() + " 년";
					}
					
					//$('.options').hide();
					//const selectedType = $(this).val();
					
					// 4개의 버튼중 하나를 선택하고, 해당 달력이 표시되며, 달력에서 날짜선택하고, 검색버튼을 클릭하면, 아래 서버에 요청하는 ajax기능을 갖고있는 아래 함수가 호출
					fn_ajax(type, url, params, labelName);
				});

				// type : 4개버튼중 선택한 버튼,  url: 스프링부트 주소,  params: 서버로 보낼 데이터, labelName : 차트제목
				function fn_ajax(type, url, params, labelName) {
					
					$.get(url, params, function (data) {


					const labels = data.map(item => item.date || item.hour || item.weekday || item.month);
					const values = data.map(item => item.total_sales);

					$(`#${type}Options`).show();

					// 차트 갱신
					if (chart  !== undefined) {
						chart.destroy();
					}

					const backgroundColors = [
						'rgba(255, 99, 132, 0.2)',
						'rgba(54, 162, 235, 0.2)',
						'rgba(255, 206, 86, 0.2)',
						'rgba(75, 192, 192, 0.2)',
						'rgba(153, 102, 255, 0.2)',
						'rgba(255, 159, 64, 0.2)',
						'rgba(199, 199, 199, 0.2)'
					];

					const borderColors = [
						'rgba(255, 99, 132, 1)',
						'rgba(54, 162, 235, 1)',
						'rgba(255, 206, 86, 1)',
						'rgba(75, 192, 192, 1)',
						'rgba(153, 102, 255, 1)',
						'rgba(255, 159, 64, 1)',
						'rgba(199, 199, 199, 1)'
					];

					// chart.js파일을 참조하여, chart객체생성.
					// ctx : <canvas>태그를 2d로 작업하는 객체.
					chart = new Chart(ctx, {
						type: 'bar',   // 차트모양
						data: {		// 차트에 사용될 데이타 작업.  labels(x축 제목), values(y축 데이타)
							labels: labels,
							datasets: [{
								label: labelName,
								data: values,
								backgroundColor: backgroundColors,
								borderColor: borderColors,
								borderWidth: 1
							}]
						},
						options: {
							scales: {
								y: {
									beginAtZero: true
								}
							}
						}
					});
				});
			 }

			});	// end ready event
	
		</script>

	</th:block>
</html>